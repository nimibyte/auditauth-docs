# Observability Internals

Observability in AuditAuth is identity-aware, plan-aware, and retention-enforced.

It is not a generic analytics system.

It is designed to provide:

- Governance-grade audit logging
- Application-level metrics
- Session-scoped analytics
- Deterministic retention enforcement

Observability operates under the same principles as Identity:

- Minimal global state
- Deterministic behavior
- Explicit boundaries
- Plan-based capability control

---

## Two Observability Domains

AuditAuth separates observability into two distinct domains:

1. Audit Logs (governance-grade)
2. Metrics (analytics-grade)

They serve different purposes and follow different guarantees.

---

## Audit Logs

Audit logs are:

- Append-only
- Identity-scoped
- Application-scoped
- Retention-bound via TTL
- PII-aware (e.g., email)

Audit logs record security and governance events such as:

- Authentication events
- Portal access
- Profile updates
- MFA configuration changes

They are designed for traceability and accountability.

---

## Metrics

Metrics are:

- Raw event-based
- Ingestion-time sampled
- Application-scoped
- Session-aware
- Retention-bound via TTL

Metrics power dashboards such as:

- Request analytics
- Navigation analytics
- Session analytics
- Custom events

Metrics are not audit-grade logs.

They are optimized for observability and aggregation.

---

## Plan-Aware Enforcement

Observability is governed by plan configuration:

- `feature_access.metrics`
- `metrics.retention_days`
- `metrics.sampling`
- `auditlog.retention_days`
- `auditlog.can_download`

Plan configuration affects:

- Whether events are stored
- How long they are retained
- Whether dashboards are visible
- Whether downloads are available

Retention is enforced at ingestion time.

---

## Physical Retention Enforcement

Retention is enforced via database TTL indexes.

When `expires_at` is reached:

- Events are physically deleted
- They are no longer queryable
- They are not logically filtered

This ensures predictable storage boundaries.

There is no separate cleanup worker.

Deletion is handled by the database engine.

---

## Sampling Model

Sampling is applied at ingestion time.

If `sampling = 0`:

- Metrics are not stored.

If sampling is less than `1`:

- Events are probabilistically recorded.
- Sampling is not deterministic per session.
- Sampling applies only to new events.

Sampling reduces storage pressure and controls analytics fidelity.

---

## Real-Time Characteristics

Dashboards operate:

- Near real-time
- Via on-demand Mongo aggregation queries
- Without pre-aggregation
- Without materialized views
- Without caching layer

Observability is query-driven.

It does not rely on streaming pipelines or batch jobs.

---

## Application Scope

All observability data is scoped by:

- `application`

Data isolation is logical, not physical.

Collections are shared but filtered by application field.

---

## Identity Awareness

Audit logs are identity-aware.

Metrics are not directly tied to user identity.

Metrics may contain:

- `session_id`
- Application context
- Request metadata

Metrics do not store direct user identifiers by default.

---

## Security Boundary

Metrics ingestion:

- Requires valid `apiKey`
- Requires valid `appId`

Metrics ingestion does not require user JWT.

Observability operates at application boundary, not per-user authentication boundary.

---

## Beta Characteristics

Current implementation:

- No pre-aggregation
- No materialized views
- No explicit indexing by timestamp
- No sharding configuration in code
- No caching layer

This is intentional in Beta.

The system favors simplicity and deterministic behavior.

---

## Architectural Position

Observability in AuditAuth is:

- Identity-aware
- Governance-compatible
- Plan-enforced
- TTL-bound
- Aggregation-driven

It is designed to complement identity infrastructure, not replace full analytics systems.

---

## Next Step

To understand how events are structured and categorized, continue with:

- Event Model
