# MFA Architecture

Multi-Factor Authentication (MFA) in AuditAuth is enforced at the identity issuance boundary.

MFA is not a post-token step.

Tokens are not issued until MFA requirements are fully satisfied.

This ensures that:

- Access tokens always represent fully verified identity state.
- There is no partial authentication state in active sessions.

---

## MFA Method

AuditAuth currently supports:

- TOTP (Time-based One-Time Password)

TOTP is:

- User-bound
- Device-generated
- Time-sensitive
- Cryptographically verifiable

Email-based and SMS-based MFA are not supported in Beta.

---

## Enforcement Model

MFA enforcement occurs at two levels:

1. Plan-level enforcement
2. User-level enforcement

Both must be satisfied before token issuance.

---

## Plan-Level Enforcement

Plans may enable or disable MFA via:

- `feature_access.mfa`

If MFA is disabled at plan level:

- MFA configuration is not available.
- MFA challenge is not triggered.

If MFA is enabled:

- Users may configure MFA.
- Enforcement may be required at login.

Plan enforcement governs capability availability.

---

## User-Level Enforcement

Each identity may have:

- `mfa.enabled`
- Associated `totp_id`

If MFA is enabled for a user:

- TOTP challenge is required during login.
- Authentication does not complete until challenge is verified.

User-level enforcement overrides plan permissiveness.

---

## MFA Validation Boundary

MFA validation occurs:

- Before issuing access token
- Before issuing refresh token
- Before creating or updating session

There is no token issuance prior to MFA completion.

This guarantees that:

- All tokens represent fully verified identity state.
- No post-issuance elevation is required.

---

## Login Flow with MFA

The login flow with MFA:

1. Primary authentication succeeds (password or provider).
2. MFA requirement is detected.
3. TOTP challenge is issued.
4. User provides valid TOTP.
5. Session is created.
6. Tokens are issued.

If MFA fails:

- No tokens are issued.
- No session is created.

---

## Partial Step-Up Support

AuditAuth supports MFA challenge during login.

There is no dedicated generic step-up endpoint in Beta.

This means:

- MFA is enforced at authentication boundary.
- Dynamic step-up for specific API calls is not implemented in Beta.

Future versions may expand step-up capabilities.

---

## Security Characteristics

MFA in AuditAuth provides:

- Protection against credential theft
- Reduced impact of password compromise
- Stronger identity assurance
- Deterministic issuance boundary

Because tokens are issued only after MFA:

- No session exists in partial authentication state.
- Enforcement complexity is minimized.

---

## Observability

MFA events generate audit entries.

This includes:

- MFA challenge success
- MFA challenge failure
- Login success after MFA

Security events are auditable.

---

## Limitations (Beta)

Current limitations:

- Only TOTP supported
- No SMS or email MFA
- No WebAuthn
- No advanced step-up API
- No per-session adaptive risk scoring

These constraints are deliberate in Beta.

---

## Architectural Guarantee

MFA is part of identity issuance.

It is not an optional add-on after token creation.

If MFA is required:

- Token issuance is blocked until verification succeeds.

Identity proof is complete before session continuity begins.

---

## Next Step

To understand how identity and application domains are separated, continue with:

- Trust Boundaries
