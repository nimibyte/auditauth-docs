# Authentication Endpoints

This section documents the formal contract of authentication-related endpoints.

It includes:

- BFF endpoints exposed by the Next.js SDK
- Upstream API endpoints where applicable

All paths are relative to the SDK BFF layer unless otherwise stated.

---

# 1. Login

## BFF Endpoint

Method:
GET

Path:
```
/api/auditauth/login
```

Query Parameters:
None

Behavior:

- Initiates authentication flow.
- Calls upstream:
  POST /v1/applications/login
- Constructs redirect URL.
- Redirects user to authentication gate.

Cookies Set:
None at this stage.

Response:

- 302 Redirect

Possible Errors:

- 404 (invalid route action)
- 5xx (upstream failure)

---

# 2. Callback

## BFF Endpoint

Method:
GET

Path:
```
/api/auditauth/callback
```

Expected Input:

- Query parameter: `code` (authorization code)

Behavior:

1. Exchanges authorization code via:
   POST /v1/auth/authorize
2. Receives:
   - access_token
   - refresh_token
   - expiration metadata
   - user data
3. Sets authentication cookies.
4. Redirects to configured redirectUrl.
5. On failure, redirects to invalid auth page.

Cookies Set:

- auditauth_session
- auditauth_access
- auditauth_refresh

Response:

- 302 Redirect (success or failure)

Possible Errors:

- 401 (invalid exchange)
- 5xx (upstream failure)

---

# 3. Logout

## BFF Endpoint

Method:
GET

Path:
```
/api/auditauth/logout
```

Behavior:

1. Clears local cookies:
   - auditauth_access
   - auditauth_refresh
   - auditauth_session
2. If access token exists:
   - Calls PATCH /v1/auth/revoke with Bearer token
3. Redirects user.

Response:

- 302 Redirect

---

# 4. Refresh

## BFF Endpoint

Method:
GET
POST

Path:
```
/api/auditauth/refresh
```

Input:

- Uses `auditauth_refresh` cookie
- Optional `redirectUrl` query parameter (GET variant)

Behavior:

Browser Flow:

- Calls upstream:
  POST /v1/auth/refresh
  client_type = browser
- Upstream returns:
  `{ access_token }`
- Refresh token rotated via cookie.
- Sets:
  - auditauth_access
  - auditauth_refresh
- Redirects if GET variant.

Server Flow:

- Calls upstream:
  POST /v1/auth/refresh
  client_type = server
- Returns:
  ```
  {
    access_token,
    access_expires_seconds,
    refresh_token,
    refresh_expires_seconds
  }
  ```

Cookies Modified:

- auditauth_access
- auditauth_refresh

Possible Responses:

- 302 (GET success)
- 401 (invalid or revoked refresh)
- 5xx

---

# 5. Session

## BFF Endpoint

Method:
GET

Path:
```
/api/auditauth/session
```

Response Schema:

```
{
  user: SessionUser
}
```

Possible Responses:

- 200 (valid session)
- 401 (no valid session)

---

# 6. Portal

## BFF Endpoint

Method:
GET

Path:
```
/api/auditauth/portal
```

Behavior:

1. Uses access token.
2. Calls upstream:
   GET /v1/portal/exchange
3. Receives exchange code.
4. Redirects to portal URL with code.

Response:

- 302 Redirect
- Fallback redirect on failure

---

# 7. Metrics Ingestion

## BFF Endpoint

Method:
POST

Path:
```
/api/auditauth/metrics
```

Headers:

Content-Type: application/json

Behavior:

- Receives metric payload.
- Injects appId and apiKey from config.
- Forwards to upstream API.

Response:

- 204 No Content

Possible Errors:

- 404 (invalid route action)

---

## Upstream API Endpoint

Method:
POST

Path:
```
/v1/metrics
```

Headers:

Content-Type: application/json

Body Schema:

```
{
  appId: string,
  apiKey: string,
  session_id: string,
  event_type: string,
  runtime: string,
  target?: string,
  metadata?: object
}
```

Response:

- 201 Created (no meaningful body)

Possible Errors:

- 401 (missing apiKey)
- 404 (invalid application)
- 403 (feature disabled)
- 429 (rate limit exceeded)

---

# Notes

- All authentication endpoints rely on cookie-based session model in browser flows.
- Refresh tokens are rotated.
- API is versioned under /v1.
- Global throttling applies.

---

## Next Step

Continue with:

- Token Exchange Flow
