# JWT Specification

This section defines the formal structure of the AuditAuth access token.

Access tokens are:

- JWT
- Signed using RS256
- Issued per application
- Short-lived (30 minutes)

Refresh tokens are not JWT.

---

# 1. Token Type

Access Token:

- Format: JWT
- Signature algorithm: RS256
- Signed with server private key
- Verified using public key endpoint

Refresh Token:

- Opaque token
- Random bytes (hex)
- Stored hashed in database
- Rotated on every refresh

---

# 2. JWT Header

Example:

```
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "main"
}
```

Fields:

alg:
- RS256

kid:
- Static value: "main"
- No multi-key support in Beta

There is no JWKS endpoint in current version.

Public key is exposed via:

```
GET /v1/public_key
```

---

# 3. JWT Payload Claims

Access token payload includes:

sub:
- Identity ID

email:
- User email

aud:
- Application ID

iss:
- Issuer identifier

app_id:
- Application identifier

account_id:
- Account identifier

iat:
- Issued at (automatic)

exp:
- Expiration timestamp

Custom claims:

- plan
- avatar
- name

Not included:

- jti
- roles
- scope
- permissions array

---

# 4. Token Lifetime

Access Token TTL:

- 30 minutes

Refresh Token TTL:

- 5 days (sliding)

There is no absolute maximum session lifetime.

Session expiration is sliding via refresh.

---

# 5. Signature Validation

Signature is validated:

- In API guards
- In SDK node verifier (@auditauth/node)

Verification includes:

- Signature check
- iss validation
- aud validation (in node SDK)
- exp validation

In some internal API flows:

- aud may not be explicitly revalidated

---

# 6. Public Key Endpoint

Endpoint:

```
GET /v1/public_key
```

Returns:

- PEM-encoded public key

Node SDK:

- Caches public key in memory
- Does not support automatic rotation

---

# 7. Revocation Model

Access tokens:

- Are not blacklisted
- Cannot be revoked directly
- Remain valid until exp

Enforcement occurs at runtime:

- Middleware checks identity state
- Session state validated
- Disabled identities blocked

Refresh tokens:

- Rotated on every refresh
- Invalidated when session revoked
- Invalidated when rotated

---

# 8. Validation Failures

Verification fails when:

- Signature invalid
- exp expired
- iss mismatch
- aud mismatch
- Token malformed

Response:

401 Unauthorized

Error shape:

```
{
  statusCode: number,
  message: string,
  error: string
}
```

---

# 9. Security Characteristics

Access tokens provide:

- Application scoping (aud)
- Account scoping (account_id)
- Identity scoping (sub)
- Short lifetime

Limitations (Beta):

- Static signing key
- No JWKS endpoint
- No key rotation support
- No jti for replay tracking
- No token introspection endpoint

---

# 10. Trust Boundary

Token signature ensures:

- Issuer authenticity
- Integrity of claims

But authorization is enforced by:

- Runtime middleware
- Session validation
- Identity status check
- Plan enforcement

A valid token does not guarantee access.

State-based enforcement applies.

---

## Next Step

Continue with:

- Error Model
