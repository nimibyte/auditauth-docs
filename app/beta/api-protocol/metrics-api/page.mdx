# Metrics Ingestion API

The Metrics API allows client applications to submit observability events.

It is application-scoped.

It is not user-authenticated.

It is plan-aware and sampling-bound.

---

# 1. BFF Endpoint

## Method

POST

## Path

```
/api/auditauth/metrics
```

## Headers

```
Content-Type: application/json
```

## Behavior

1. Receives metric payload from client.
2. Injects:
   - appId
   - apiKey
3. Forwards request to upstream API.
4. Returns 204 No Content.

## Success Response

204 No Content

## Failure Response

- 404 (invalid route action)
- 5xx (upstream failure)

---

# 2. Upstream API Endpoint

## Method

POST

## Path

```
/v1/metrics
```

## Headers

```
Content-Type: application/json
```

CORS:

- Enabled globally
- Origin-restricted
- Credentials allowed

---

## Request Body Schema

```
{
  appId: string,
  apiKey: string,
  session_id: string,
  event_type: "request" | "navigation" | "custom",
  runtime: string,
  target?: string,
  metadata?: object
}
```

### Field Definitions

appId:
- Identifies application.
- Validated against registered applications.

apiKey:
- Validates application ownership.
- Required for ingestion.

session_id:
- Client-generated identifier.
- Used for aggregation grouping.

event_type:
- Defines metric category.

runtime:
- Client runtime identifier (e.g., web, next, etc.).

target (optional):
- Request path or navigation target.

metadata (optional):
- Arbitrary object.
- No automatic anonymization.
- Client is responsible for avoiding sensitive data.

---

# 3. Ingestion Behavior

Before persistence, system evaluates:

- Valid application
- Valid apiKey
- Plan feature_access.metrics
- metrics.retention_days
- metrics.sampling

If any condition fails:

- Metric is discarded or request rejected.

Sampling is applied:

- At ingestion time
- Per event
- Probabilistically

Retention is applied:

- At ingestion time
- expires_at is computed
- TTL index handles deletion

---

# 4. Success Response

Status:

201 Created

Body:

- No meaningful response payload.

---

# 5. Error Responses

Possible HTTP status codes:

401 Unauthorized
- Missing apiKey
- Invalid apiKey

404 Not Found
- Invalid application

403 Forbidden
- Feature disabled by plan

429 Too Many Requests
- Rate limit exceeded

5xx
- Internal server error

Error response format (Nest default):

```
{
  statusCode: number,
  message: string,
  error: string
}
```

---

# 6. Security Characteristics

Metrics ingestion:

- Does not require user JWT
- Requires valid apiKey and appId
- Is subject to global throttling (120 req / 60s per IP)

Observability operates at application boundary.

Identity state does not block metrics ingestion.

---

# 7. Rate Limiting

Global throttler configuration:

- 120 requests per 60 seconds
- Per IP (default Nest Throttler behavior)

Response:

429 Too Many Requests

Retry-After header:

- Not explicitly implemented in current code.

---

# 8. CORS Model

CORS is:

- Enabled globally
- Origin-restricted
- Credentials allowed
- Access-Control-Allow-Credentials: true

Origins are validated against:

- Allowed domains per application
- localhost:3000 (development)

---

# 9. Beta Limitations

Current implementation:

- No raw metrics export endpoint
- No per-user metrics enforcement
- No dedicated ingestion audit trail
- No pre-aggregation
- No caching layer

Metrics are stored raw and aggregated on demand.

---

## Next Step

Continue with:

- JWT Specification
